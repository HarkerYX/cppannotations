#!/usr/bin/icmake -qt/tmp/cppannotations

#include "INSTALL.im"
#include "compilers.im"

#define ECHO_COMMANDS       1
// #define COPT                "-Wall -O2 -g"
// #define CPPOPT              "--std=c++14 -Wall -O2 -g"

string
    g_cwd;              // current WD

#include "icmake/run"
#include "icmake/clean"
#include "icmake/programs"
#include "icmake/man"
#include "icmake/docs"
#include "icmake/latex"
#include "icmake/pre"
#include "icmake/install"
#include "icmake/distclean"
#include "icmake/zips"
#include "icmake/examples"
#include "icmake/verify"

void main(int argc, list argv, list envp)
{
    string option;

    echo(ECHO_COMMANDS);

    option = element(1, argv);
    g_cwd = chdir(".");

    setLocations();     // from INSTALL.im

    if (option == "clean")
        clean(1);

    if (option == "examples")
        examples();

    if (option == "programs")
    {
        programs(0);
        programs(1);
        exit(0);
    }

    if (option == "distclean")
        distclean();

    if (option == "pre")
        pre();

    if (option == "docs")
        docs();

    if (option == "html")
        runhtml();

    if (option == "latex")
        latex();

    if (option == "ps")
        runps();

    if (option == "txt")
        runtxt();

    if (option == "verify")
        verify();

    if (option == "zips")
        zips();

    if (option == "man")
    {
        man();
        exit(0);
    }

    if (option == "install")
        install(0, element(2, argv));

    if (option == "cinstall")
        install(1, element(2, argv));

    printf("Usage: build what [x]\n"
        "Where `what' is one of:\n"
        "   clean           - clean up remnants of previous compilations\n"
        "   cinstall <base> - to install the C++ Annotations in the "
                                                                "locations\n"
        "                     defined in the INSTALL.im file, optionally\n"
        "                     below <base>\n"
        "   distclean       - clean remnants of locally run ./bin/ scripts\n"
        "\n"
        "   docs            - construct the C++ Annotations\n"
        "                     Run 'build programs' and 'build pre' at least\n"
        "                     once before 'build docs'\n"
        "\n"
        "   examples        - compile all examples\n"
        "   install <base>  - to install the C++ Annotations in the "
                                                                "locations\n"
        "                     defined in the INSTALL.im file, optionally\n"
        "                     below <base>\n"
        "   html            - force the html construction\n"
        "   latex           - force the latex construction, (cf 'verify')\n"
        "   man             - build the manual page (requires Yodl)\n"
        "   pre             - prepare files for independent `docs' call\n"
        "   ps              - create .ps/.pdf files afer 'build latex'\n"
        "   programs        - build support programs\n"
        "   txt             - force the txt construction\n"
        "   verify          - run after `build docs' to find overfull boxes\n"
        "                     or undefined references in\n"
        "                     tmp/docs/latex/cplusplus.log\n"
        "   zips            - zip archives (after doc)\n"
        "\n"
    );
    exit(1);
}


